<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no" />
<title>1v1 · 相机上传 + 聊天（深色·紧凑）</title>
<style>
  :root{
    /* 深色主题 */
    --bg:#0b0f14;
    --card:#121820;
    --border:#1f2630;
    --text:#e7edf6;
    --text-2:#9fb0c3;
    --primary:#6d8bff;
    --primary-2:#516cff;
    --mine:#172033;
    --mine-b:#2a3a55;
    --radius:12px;

    /* 尺寸（紧凑） */
    --fz:14px;            /* 全局文字 */
    --pad:8px;            /* 卡片/按钮内边距 */
    --gap:8px;            /* 组件间距 */
    --thumbH:140px;       /* 图片缩略图高度 */
    --headerH:48px;
    --toolbarH:70px;      /* 工具条大致高度（用于内容区计算） */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    background:var(--bg);
    color:var(--text);
    font-size:var(--fz);
  }

  /* 顶栏（更薄） */
  header{
    position:sticky; top:0; z-index:10;
    height:var(--headerH);
    display:flex; align-items:center;
    gap:var(--gap);
    background:var(--card);
    border-bottom:1px solid var(--border);
    padding:0 var(--gap);
    padding-left:calc(env(safe-area-inset-left) + var(--gap));
    padding-right:calc(env(safe-area-inset-right) + var(--gap));
  }
  .row{display:flex; gap:var(--gap); align-items:center}
  input,button,select{
    font-size:16px; /* 防 iOS 聚焦放大 */
    padding:8px 10px;
    border:1px solid var(--border);
    border-radius:10px;
    background:#0f141b;
    color:var(--text);
  }
  input::placeholder{color:#7b8a9a}
  button{background:#0f141b}
  button.primary{background:var(--primary); border-color:transparent; color:#fff}
  button.primary:active{background:var(--primary-2)}
  label{color:var(--text-2); display:flex; align-items:center; gap:6px}

  /* 内容区（更紧凑） */
  #content{
    height:calc(100dvh - var(--headerH) - var(--toolbarH));
    padding:var(--gap);
    overflow:auto;
  }
  #log{display:flex; flex-direction:column; gap:6px}
  .msg{
    background:#0f141b;
    border:1px solid var(--border);
    border-radius:10px;
    padding:6px 8px;
  }
  .msg.mine{background:var(--mine); border-color:var(--mine-b)}
  .author{font-weight:600; margin-right:6px}
  .time{color:var(--text-2); font-size:12px; margin-left:6px}

  /* 图片缩略图更小、更克制 */
  .msg img.thumb{
    display:block;
    width:100%;
    max-height:var(--thumbH);
    object-fit:cover;
    border-radius:8px;
    cursor:zoom-in;
  }

  /* 底部工具条（更薄） */
  #toolbar{
    position:sticky; bottom:0; z-index:10;
    background:var(--card);
    border-top:1px solid var(--border);
    padding:6px var(--gap);
    padding-left:calc(env(safe-area-inset-left) + var(--gap));
    padding-right:calc(env(safe-area-inset-right) + var(--gap));
  }
  #toolRow,#sendRow{display:flex; gap:6px}
  #text{flex:1}

  /* 全屏查看器（深色） */
  #viewer{
    position:fixed; inset:0; display:none; z-index:9999;
    background:rgba(0,0,0,.96); color:#fff;
    padding-top:env(safe-area-inset-top); padding-bottom:env(safe-area-inset-bottom);
  }
  #viewer.show{display:block}
  #viewerTop{position:absolute; left:0; right:0; top:0; display:flex; justify-content:space-between; padding:10px 14px}
  #viewerClose{border:0; border-radius:10px; background:rgba(255,255,255,.16); color:#fff; padding:6px 10px}
  #viewerCount{opacity:.85; font-size:13px}
  #viewerStage{position:absolute; inset:0; top:42px; overflow:hidden; touch-action:none}
  #viewerImg{position:absolute; left:50%; top:50%; transform:translate(-50%,-50%) scale(1); transform-origin:center; will-change:transform; max-width:none; max-height:none}
  .viewer-nav{position:absolute; top:50%; transform:translateY(-50%); width:40px; height:40px; border:0; border-radius:10px; background:rgba(255,255,255,.18); color:#fff; font-size:20px}
  #viewerPrev{left:10px} #viewerNext{right:10px}
</style>
</head>
<body>
  <!-- 顶栏 -->
  <header>
    <div class="row" style="width:100%">
      <input id="room" placeholder="房间ID（字母数字）">
      <button id="join" class="primary">加入/创建</button>
      <label><input type="checkbox" id="bluetoothMode"> 朗读对方</label>
    </div>
  </header>

  <!-- 内容 -->
  <main id="content"><div id="log"></div></main>

  <!-- 底部工具条（紧凑） -->
  <div id="toolbar">
    <div id="toolRow">
      <button id="openCam">开启相机</button>
      <button id="shot" class="primary" style="flex:1">拍照上传</button>
      <button id="closeCam" style="background:#3b0e10;border-color:#5b1b20;color:#ffd5d6">关闭相机</button>
    </div>
    <div id="sendRow">
      <input id="text" placeholder="发消息…（回车发送）">
      <button id="send" class="primary">发送</button>
    </div>
    <video id="preview" autoplay playsinline muted style="width:1px;height:1px;opacity:0;position:absolute;left:-9999px"></video>
  </div>

  <!-- 全屏图片查看器 -->
  <div id="viewer" aria-hidden="true">
    <div id="viewerTop">
      <button id="viewerClose">关闭</button>
      <span id="viewerCount"></span>
    </div>
    <div id="viewerStage"><img id="viewerImg" alt=""></div>
    <button id="viewerPrev" class="viewer-nav">‹</button>
    <button id="viewerNext" class="viewer-nav">›</button>
  </div>

<script type="module">
/*********** Supabase ***********/
const SUPABASE_URL = "https://rcytjdvqyqbvuyzfcinu.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJjeXRqZHZxeXFidnV5emZjaW51Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1NDc2MzUsImV4cCI6MjA3NTEyMzYzNX0.RyG8f5IL_Yt0UL_rsrP7UILncM9Ek4TMIYq1dr2Zb-U";
const BUCKET = "photos";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/*********** DOM helpers ***********/
const $=s=>document.querySelector(s);
const logWrap=$("#log");
const seenIds=new Set();
const allImageUrls=[];

function fmtTime(s){ try{return new Date(s).toLocaleTimeString()}catch{return ""} }
function speak(t){ if(!$("#bluetoothMode").checked) return; try{const u=new SpeechSynthesisUtterance(t);u.lang="zh-CN";speechSynthesis.speak(u)}catch{} }

/*********** 渲染 ***********/
function registerThumb(imgEl,url){
  let idx=allImageUrls.indexOf(url);
  if(idx===-1){ allImageUrls.push(url); idx=allImageUrls.length-1;}
  imgEl.dataset.index=idx;
  imgEl.addEventListener("click",()=>openViewer(idx));
}
function appendMsg({id,author,content,created_at}){
  if(seenIds.has(id)) return; seenIds.add(id);
  const mine=author==="我";
  const div=document.createElement("div");
  div.className="msg"+(mine?" mine":"");
  const head=`<span class="author">${author}</span><span class="time">${fmtTime(created_at)}</span>`;
  if(/^https?:\/\/.+\.(jpg|jpeg|png|webp|gif)(\?.*)?$/i.test(content)){
    div.innerHTML=`${head}<br><img class="thumb" src="${content}" alt="">`;
    logWrap.appendChild(div);
    registerThumb(div.querySelector("img"),content);
  }else{
    div.innerHTML=`${head}<span>：${content}</span>`;
    logWrap.appendChild(div);
  }
  $("#content").scrollTop=$("#content").scrollHeight;
  if(!mine) speak(content);
}

/*********** 房间/Realtime ***********/
let roomId=new URL(location.href).searchParams.get("room")||"";
if(roomId) $("#room").value=roomId;
let dbChannel=null;

async function loadHistory(){
  const {data,error}=await supabase.from("messages").select("*").eq("room_id",roomId).order("created_at",{ascending:true}).limit(200);
  logWrap.innerHTML=""; seenIds.clear(); allImageUrls.length=0;
  if(!error && data) data.forEach(appendMsg);
}
async function joinRoom(){
  roomId=$("#room").value.trim()||crypto.randomUUID().slice(0,8);
  const u=new URL(location.href); u.searchParams.set("room",roomId); history.replaceState(null,"",u);
  await loadHistory();
  if(dbChannel) await supabase.removeChannel(dbChannel);
  dbChannel=supabase.channel("db:"+roomId)
   .on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`room_id=eq.${roomId}`},p=>appendMsg(p.new))
   .subscribe();
}
$("#join").onclick=joinRoom; if(roomId) joinRoom();

/*********** 文本发送（仅插入，防重复） ***********/
async function sendText(){
  const v=$("#text").value.trim(); if(!v||!roomId) return;
  const {error}=await supabase.from("messages").insert({room_id:roomId,author:"我",content:v});
  if(error) alert("发送失败："+error.message);
  $("#text").value="";
}
$("#send").onclick=sendText;
$("#text").addEventListener("keydown",e=>{ if(e.key==="Enter") sendText(); });

/*********** 相机 ***********/
let mediaStream=null; const video=$("#preview");
$("#openCam").onclick=async()=>{
  if(mediaStream) return;
  try{
    mediaStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"},audio:false});
    video.srcObject=mediaStream;
  }catch(e){ alert("相机权限失败："+e.message); }
};
$("#closeCam").onclick=()=>{
  if(!mediaStream) return;
  mediaStream.getTracks().forEach(t=>t.stop());
  mediaStream=null; video.srcObject=null;
};
$("#shot").onclick=async()=>{
  if(!roomId) return alert("请先加入房间");
  if(!mediaStream) return alert("请先开启相机");
  const c=document.createElement("canvas");
  const w=video.videoWidth||1280,h=video.videoHeight||720;
  c.width=w; c.height=h; c.getContext("2d").drawImage(video,0,0,w,h);
  const blob=await new Promise(r=>c.toBlob(r,"image/jpeg",0.9));
  const fname=`${roomId}/${Date.now()}-${Math.random().toString(16).slice(2)}.jpg`;
  const {error:upErr}=await supabase.storage.from("photos").upload(fname,blob,{contentType:"image/jpeg",upsert:false});
  if(upErr){ alert("上传失败："+upErr.message); return; }
  const {data:pub}=supabase.storage.from("photos").getPublicUrl(fname);
  await supabase.from("messages").insert({room_id:roomId,author:"我",content:pub.publicUrl});
};

/*********** 全屏查看器（同上一版） ***********/
const viewer=$("#viewer"), viewerImg=$("#viewerImg"), viewerCount=$("#viewerCount"), btnPrev=$("#viewerPrev"), btnNext=$("#viewerNext");
$("#viewerClose").onclick=()=>viewer.classList.remove("show");
let current=0, scale=1, baseScale=1, startMid=null, startDist=0, tx=0, ty=0, startTx=0, startTy=0, touchStartX=0, lastTap=0;
function openViewer(i){ current=i; updateImage(); resetTransform(); viewer.classList.add("show"); }
function updateImage(){
  viewerImg.src=allImageUrls[current];
  viewerCount.textContent=`${current+1} / ${allImageUrls.length}`;
  btnPrev.style.display=(current>0)?'block':'none';
  btnNext.style.display=(current<allImageUrls.length-1)?'block':'none';
}
btnPrev.onclick=()=>{ if(current>0){ current--; updateImage(); resetTransform(); } };
btnNext.onclick=()=>{ if(current<allImageUrls.length-1){ current++; updateImage(); resetTransform(); } };
const stage=document.getElementById("viewerStage");
stage.addEventListener("click",()=>{ const now=Date.now(); if(now-lastTap<300){ scale=(scale>1)?1:2.2; tx=ty=0; applyTransform(); } lastTap=now; });
stage.addEventListener("touchstart",(e)=>{ if(e.touches.length===1){ touchStartX=e.touches[0].clientX; startTx=tx; startTy=ty; } else if(e.touches.length===2){ const p1=e.touches[0],p2=e.touches[1]; startDist=dist(p1,p2); startMid=mid(p1,p2); baseScale=scale; } },{passive:false});
stage.addEventListener("touchmove",(e)=>{
  if(e.touches.length===1 && scale>1){ const p=e.touches[0]; tx=startTx+(p.clientX-touchStartX); ty=startTy+(p.clientY-(startMid?.clientY??p.clientY)); clampPan(); applyTransform(); e.preventDefault(); }
  else if(e.touches.length===2){ const p1=e.touches[0],p2=e.touches[1]; const factor=dist(p1,p2)/Math.max(1,startDist); scale=Math.min(4,Math.max(1,baseScale*factor)); applyTransform(); e.preventDefault(); }
},{passive:false});
stage.addEventListener("touchend",(e)=>{
  if(e.touches.length===0 && !startMid && scale===1){
    const endX=(e.changedTouches[0]||{}).clientX??0, delta=endX-touchStartX;
    if(Math.abs(delta)>60){ if(delta<0 && current<allImageUrls.length-1){ current++; updateImage(); } else if(delta>0 && current>0){ current--; updateImage(); } }
  }
  if(scale<1){ scale=1; tx=ty=0; applyTransform(); }
  if(scale>4){ scale=4; applyTransform(); }
  startMid=null;
});
function applyTransform(){ viewerImg.style.transform=`translate(calc(-50% + ${tx}px), calc(-50% + ${ty}px)) scale(${scale})`; }
function resetTransform(){ scale=1; tx=ty=0; applyTransform(); }
function clampPan(){ const limit=200*(scale-1); tx=Math.max(-limit,Math.min(limit,tx)); ty=Math.max(-limit,Math.min(limit,ty)); }
function dist(a,b){ const dx=a.clientX-b.clientX, dy=a.clientY-b.clientY; return Math.hypot(dx,dy); }
function mid(a,b){ return {clientX:(a.clientX+b.clientX)/2, clientY:(a.clientY+b.clientY)/2}; }
</script>
</body>
</html>
