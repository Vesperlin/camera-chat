<!doctype html>
<html lang="zh-CN">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>1v1 · 相机上传 + 聊天（深色·黑白）</title>
<style>
  :root{
    --bg:#0f1115;
    --panel:#12151c;
    --panel-2:#0d0f14;
    --text:#e9edf1;
    --sub:#97a1ad;
    --line:#1e2430;
    --brand:#6b8afd;
    --brand-weak:#2b3350;
    --mine:#1b2431;
    --peer:#151b24;
    --danger:#742a2a;
    --r:14px;
    --gap:10px;
    --safe:env(safe-area-inset-bottom);
    --max-bubble:72vw;
    --img-thumb:44vw;
    --img-thumb-lg:84vw;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font:15px/1.5 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Noto Sans SC",sans-serif;
  }
  .wrap{height:100%;display:flex;flex-direction:column}
  .top{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,var(--panel-2),var(--panel));border-bottom:1px solid var(--line);padding:10px 12px 8px;}
  .top-row{display:flex;gap:8px;align-items:center}
  .ipt{flex:1;background:#0c0f14;border:1px solid var(--line);color:var(--text);border-radius:12px;height:40px;padding:0 12px;outline:none}
  .btn{background:var(--brand);color:#fff;border:0;border-radius:12px;height:40px;padding:0 14px;font-weight:600}
  .chk{display:flex;align-items:center;gap:6px;color:var(--sub);font-size:13px}
  .modes{display:flex;gap:8px;margin-top:8px}
  .seg{display:flex;gap:4px;background:#0c0f14;border:1px solid var(--line);border-radius:999px;padding:4px}
  .seg button{background:transparent;border:0;color:var(--sub);padding:6px 10px;border-radius:999px}
  .seg button.active{background:var(--brand-weak);color:#dbe3ff}
  #log{flex:1;overflow:auto;padding:10px 8px 6px;display:flex;flex-direction:column;gap:8px;background:radial-gradient(1100px 700px at 50% -220px,#0b0e14,transparent),var(--bg);}
  .time-divider{align-self:center;color:#7f8a98;font-size:12px;padding:4px 10px;border:1px solid var(--line);border-radius:999px;opacity:.9;margin:6px 0 2px}
  .row{display:flex;gap:8px}
  .row.peer{justify-content:flex-start}
  .row.self{justify-content:flex-end}
  .msg{max-width:var(--max-bubble);background:var(--peer);border:1px solid var(--line);padding:8px 10px;border-radius:12px;box-shadow:0 3px 10px rgba(0,0,0,.18);}
  .self .msg{background:var(--mine)}
  .nick{color:var(--sub);font-size:12px;margin:0 0 4px 2px}
  .msg p{margin:0;white-space:pre-wrap;word-break:break-word}
  .msg img{display:block;width:var(--img-thumb);height:auto;border-radius:10px;border:1px solid var(--line)}
  .msg.enlarge img{width:min(var(--img-thumb-lg),520px)}
  .msg a{display:inline-block}
  .footer{position:sticky;bottom:0;z-index:10;background:linear-gradient(180deg,transparent,rgba(0,0,0,.35))}
  .toolbar{display:flex;gap:8px;align-items:center;padding:8px 12px;background:var(--panel);border-top:1px solid var(--line)}
  .tbtn{background:#0d1016;border:1px solid var(--line);color:var(--text);height:36px;padding:0 12px;border-radius:999px}
  .tbtn.danger{background:#160d0d;border-color:#3a2020;color:#ffd6d6}
  .composer{display:flex;gap:8px;align-items:center;padding:8px 12px calc(8px + var(--safe));background:var(--panel);border-top:1px solid var(--line)}
  #text{flex:1;background:#0c0f14;border:1px solid var(--line);color:var(--text);border-radius:12px;height:40px;padding:0 12px;outline:none}
  #send{background:var(--brand);color:#fff;border:0;border-radius:999px;height:40px;padding:0 16px;font-weight:700}
  .viewer{position:fixed;inset:0;background:rgba(0,0,0,.92);display:none;align-items:center;justify-content:center;z-index:999}
  .viewer img{max-width:100vw;max-height:100vh}
  .viewer.show{display:flex}
  .sheet-mask{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:98}
  .sheet{position:fixed;left:0;right:0;bottom:0;transform:translateY(100%);background:var(--panel);border-top:1px solid var(--line);z-index:99;transition:.25s}
  .sheet.show{transform:translateY(0)}
  .sheet-mask.show{display:block}
  .sheet-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;padding:16px}
  .sheet-item{height:74px;border:1px solid var(--line);background:#0e1118;border-radius:14px;display:flex;align-items:center;justify-content:center;color:#d7dfeb;font-weight:600}
  /* === 相机全屏 === */
  .cam-pane{position:fixed;inset:0;background:#000;display:none;z-index:95}
  .cam-pane.show{display:block}
  /* 关键：iOS兼容属性 */
  #camView{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transform:rotate(0deg);playsinline:;muted:;autoplay:;}
  .cam-controls{position:absolute;left:0;right:0;bottom:0;padding:12px 12px calc(12px + var(--safe));display:flex;gap:10px;justify-content:center;background:linear-gradient(180deg,transparent,rgba(0,0,0,.6))}
  .cam-btn{height:44px;border-radius:999px;border:0;padding:0 16px;font-weight:700}
  .cam-btn{background:#1c2432;color:#fff;border:1px solid #2a3548}
  .cam-btn.danger{background:#5a1d1d;border:1px solid #7a3030}
  .toast{position:fixed;left:50%;bottom:calc(16px + var(--safe));transform:translateX(-50%);background:#11161e;color:#e9edf1;border:1px solid var(--line);padding:8px 12px;border-radius:10px;opacity:0;pointer-events:none;transition:.2s;z-index:200}
  .toast.show{opacity:1}
</style>

<div class="wrap">
  <div class="top">
    <div class="top-row">
      <input id="room" class="ipt" placeholder="房间ID（字母数字）" inputmode="latin">
      <button id="join" class="btn">加入/创建</button>
      <label class="chk"><input id="ttsToggle" type="checkbox"> 朗读对方</label>
    </div>
    <div class="modes">
      <div class="seg" id="modeSeg">
        <button data-mode="only-peer" class="active">只放大对方</button>
        <button data-mode="all-small">全部缩略</button>
        <button data-mode="all-large">全部放大</button>
      </div>
    </div>
  </div>

  <div id="log"></div>

  <div id="viewer" class="viewer"><img alt=""></div>

  <div class="footer">
    <div class="toolbar">
      <button id="plusBtn" class="tbtn">更多</button>
      <button id="openCam" class="tbtn">相机</button>
      <button id="shot" class="tbtn">拍照上传</button>
      <button id="closeCam" class="tbtn danger">关闭相机</button>
    </div>
    <div class="composer">
      <input id="text" placeholder="发消息…（回车发送）">
      <button id="send">发送</button>
    </div>
  </div>

  <div id="sheetMask" class="sheet-mask"></div>
  <section id="sheet" class="sheet" aria-hidden="true">
    <div class="sheet-grid">
      <div class="sheet-item" id="sheetTemplate">模板</div>
      <div class="sheet-item" id="sheetUpload">上传图片</div>
      <div class="sheet-item" id="sheetCamera">打开相机</div>
      <div class="sheet-item" id="sheetMode">切换图片模式</div>
    </div>
  </section>

  <!-- ✅ 改好的相机全屏段（含 iPhone 兼容属性） -->
  <section id="camPane" class="cam-pane" aria-hidden="true">
    <video id="camView" playsinline muted autoplay></video>
    <div class="cam-controls">
      <button id="shootBtn" class="cam-btn">拍照并上传</button>
      <button id="closeCamBtn" class="cam-btn danger">关闭相机</button>
    </div>
  </section>

  <div id="toast" class="toast"></div>
</div>

<!-- 载入逻辑 -->
<script type="module" src="chat.js"></script>
</html>
