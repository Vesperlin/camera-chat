<!doctype html>
<html lang="zh-CN">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>1v1 · 相机上传 + 聊天（移动端优先 · 黑白）</title>
<style>
  :root{
    /* 颜色：黑白系（可按需微调） */
    --bg:#0f1115;
    --panel:#151821;
    --panel-2:#0f1218;
    --text:#e9edf1;
    --sub:#9aa3af;
    --line:#1f2430;
    --brand:#6b8afd;          /* 主按钮 */
    --brand-weak:#2a344d;
    --mine:#1f2a3a;           /* 自己气泡 */
    --other:#171c25;          /* 对方气泡 */
    --danger:#7a1c1c;

    --radius:14px;
    --radius-lg:18px;
    --gap:10px;

    --max-bubble-w:74vw;      /* 气泡最大宽度 */
    --img-thumb-w:44vw;       /* 缩略图宽度（更小） */
    --img-tiny-radius:10px;

    --toolbar-h:48px;
    --composer-h:52px;
    --safe: env(safe-area-inset-bottom);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font:16px/1.45 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans SC","PingFang SC",sans-serif;
  }
  a{color:inherit}
  .wrap{height:100%;display:flex;flex-direction:column}

  /* 顶栏 */
  .top{
    padding:10px 12px 8px;
    border-bottom:1px solid var(--line);
    background:linear-gradient(180deg,var(--panel-2),var(--panel));
    position:sticky;top:0;z-index:5;
  }
  .top-row{display:flex;gap:10px;align-items:center}
  .ipt{
    flex:1;background:#0c0f14;border:1px solid var(--line);color:var(--text);
    padding:10px 12px;border-radius:12px;min-height:40px
  }
  .btn{
    background:var(--brand);color:#fff;border:0;border-radius:12px;
    padding:10px 14px;font-weight:600;min-height:40px
  }
  .chk{display:flex;align-items:center;gap:8px;color:var(--sub);font-size:14px}

  /* 切换条 */
  .modes{display:flex;gap:8px;margin-top:8px}
  .seg{display:flex;background:#0c0f14;border:1px solid var(--line);border-radius:1000px;padding:4px}
  .seg button{
    background:transparent;color:var(--sub);border:0;padding:8px 14px;border-radius:999px
  }
  .seg button.active{background:var(--brand-weak);color:#cbd5ff}

  /* 消息区 */
  #log{
    flex:1;overflow:auto;padding:10px 12px 8px;
    display:flex;flex-direction:column;gap:10px;
    background:radial-gradient(1200px 800px at 50% -200px,#0c0f14,transparent),var(--bg);
  }
  .msg{
    max-width:var(--max-bubble-w);padding:10px 12px;border-radius:var(--radius);
    background:var(--other);border:1px solid var(--line);position:relative;
    box-shadow:0 3px 10px rgba(0,0,0,.18);
  }
  .mine{align-self:flex-end;background:var(--mine)}
  .meta{color:var(--sub);font-size:12px;margin-bottom:6px;display:flex;gap:8px}
  .msg p{margin:0;white-space:pre-wrap;word-break:break-word}

  /* 图片（默认更小） */
  .msg img{
    display:block;width:var(--img-thumb-w);height:auto;border-radius:var(--img-tiny-radius);
    border:1px solid var(--line)
  }
  /* 放大模式应用在带 .enlarge 的消息 */
  .msg.enlarge img{width:min(84vw,520px)}
  .msg a{display:inline-block}

  /* 底部：工具栏 + 输入栏 贴合在一起 */
  .bottom{
    position:sticky;bottom:0;z-index:5;background:linear-gradient(180deg,transparent,rgba(0,0,0,.35));
  }
  .toolbar{
    height:var(--toolbar-h);display:flex;gap:8px;align-items:center;
    padding:8px 12px;background:var(--panel);border-top:1px solid var(--line);
  }
  .tbtn{
    background:#0c0f14;border:1px solid var(--line);color:var(--text);padding:8px 12px;border-radius:999px;
  }
  .tbtn.danger{background:#1a0e0e;border-color:#3a2020;color:#ffd5d5}
  .composer{
    height:calc(var(--composer-h) + var(--safe));display:flex;gap:8px;align-items:center;
    padding:8px 12px;padding-bottom:calc(8px + var(--safe));background:var(--panel-2);border-top:1px solid var(--line);
  }
  #text{flex:1;background:#0c0f14;border:1px solid var(--line);color:var(--text);
    border-radius:12px;height:36px;padding:8px 12px}
  #send{height:36px;border-radius:10px;padding:0 16px}
  .link{color:#9eb6ff;text-decoration:none}
  /* 全屏预览 */
  .viewer{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;z-index:999}
  .viewer img{max-width:100vw;max-height:100vh}
  .viewer.show{display:flex}
</style>

<div class="wrap">
  <!-- 顶栏 -->
  <div class="top">
    <div class="top-row">
      <input id="room" class="ipt" placeholder="房间ID（字母数字）" inputmode="latin">
      <button id="join" class="btn">加入/创建</button>
      <label class="chk"><input id="bluetoothMode" type="checkbox"> 朗读对方</label>
    </div>
    <div class="modes">
      <div class="seg" id="modeSeg">
        <button data-mode="only-other" class="active">只放大对方</button>
        <button data-mode="all-small">全部缩略</button>
        <button data-mode="all-large">全部放大</button>
      </div>
      <small style="color:var(--sub);align-self:center;">（可随时切换）</small>
    </div>
  </div>

  <!-- 消息列表 -->
  <div id="log"></div>

  <!-- 底部：工具栏 + 输入 -->
  <div class="bottom">
    <div class="toolbar">
      <button id="openCam" class="tbtn">开启相机</button>
      <button id="shot" class="tbtn">拍照上传</button>
      <button id="closeCam" class="tbtn danger">关闭相机</button>
      <button id="tplBtn" class="tbtn">模板</button>
    </div>
    <div class="composer">
      <input id="text" placeholder="发消息…（回车发送）">
      <button id="send" class="btn">发送</button>
    </div>
  </div>
</div>

<!-- 全屏图片预览 -->
<div id="viewer" class="viewer" aria-hidden="true"><img alt="preview"></div>

<script type="module">
/** ====== 基础配置（改成你的） ====== **/
const SUPABASE_URL = "https://YOUR-PROJECT.supabase.co";        // ← 改成你的
const SUPABASE_ANON_KEY = "YOUR-ANON-KEY";                       // ← 改成你的
const BUCKET = "photos";                                         // ← 你的桶名

import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/** ====== DOM 简易工具 ====== **/
const $ = s => document.querySelector(s);
const logEl = $("#log");

/** ====== 状态 ====== **/
let roomId = new URL(location.href).searchParams.get("room") || "";
if(roomId) $("#room").value = roomId;

let mediaStream = null;
let dbChannel = null;
let imageMode = "only-other";  // only-other | all-small | all-large

/** ====== 小工具 ====== **/
const speak = (text)=>{
  if(!$("#bluetoothMode").checked) return;
  try{
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "zh-CN"; speechSynthesis.speak(u);
  }catch(e){}
};
const isImgURL = (s)=> /^https?:\/\/.+\.(jpg|jpeg|png|webp|gif)(\?.*)?$/i.test(s);
const nowHHMMSS = ()=> new Date().toTimeString().slice(0,8);

/** ====== 渲染 ====== **/
function renderMessage(author, content, mine=false, createdAt=null){
  const wrap = document.createElement("div");
  wrap.className = "msg" + (mine ? " mine" : "");
  const meta = document.createElement("div");
  meta.className = "meta";
  meta.textContent = (mine ? "我" : "对方") + "  " + (createdAt || nowHHMMSS());
  wrap.appendChild(meta);

  if(isImgURL(content)){
    const a = document.createElement("a");
    a.href = content; a.className="img-link";
    const img = document.createElement("img"); img.src = content; a.appendChild(img);
    wrap.appendChild(a);
    // 放大条件
    const shouldLarge =
      (imageMode==="all-large") ||
      (imageMode==="only-other" && !mine);
    if(shouldLarge) wrap.classList.add("enlarge");
  }else{
    const p = document.createElement("p");
    p.textContent = content;
    wrap.appendChild(p);
  }
  logEl.appendChild(wrap);
  logEl.scrollTop = logEl.scrollHeight;
}

/** ====== 历史 & 实时 ====== **/
async function loadHistory(){
  const { data, error } = await supabase
    .from("messages")
    .select("author,content,created_at")
    .eq("room_id", roomId)
    .order("created_at", { ascending:true })
    .limit(300);
  if(error) return;
  logEl.innerHTML = "";
  for(const m of data){
    renderMessage(m.author, m.content, m.author==="我", m.created_at?.slice(11,19));
  }
}
async function joinRoom(){
  roomId = $("#room").value.trim() || crypto.randomUUID().slice(0,8);
  const url = new URL(location.href); url.searchParams.set("room",roomId);
  history.replaceState(null,"",url);

  await loadHistory();

  if(dbChannel) await supabase.removeChannel(dbChannel);
  dbChannel = supabase
    .channel("db:"+roomId)
    .on("postgres_changes",
      { event:"INSERT", schema:"public", table:"messages", filter:`room_id=eq.${roomId}` },
      payload=>{
        const m = payload.new;
        const mine = (m.author==="我");
        renderMessage(m.author, m.content, mine, m.created_at?.slice(11,19));
        if(!mine && !isImgURL(m.content)) speak(m.content);
      }
    ).subscribe();
}

/** ====== 发送文字 ====== **/
async function sendText(v){
  if(!v) return;
  const { error } = await supabase.from("messages").insert({ room_id:roomId, author:"我", content:v });
  if(error){ alert("发送失败："+error.message); return; }
  renderMessage("我", v, true);
  $("#text").value="";
}

/** ====== 相机 ====== **/
$("#openCam").onclick = async ()=>{
  try{
    mediaStream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" }, audio:false });
    alert("相机已打开（后台采集，直接点“拍照上传”即可）");
  }catch(e){ alert("相机权限失败："+e.message); }
};
$("#shot").onclick = async ()=>{
  if(!mediaStream) return alert("请先开启相机");
  const video = document.createElement("video");
  video.srcObject = mediaStream; await video.play();
  await new Promise(r=> requestAnimationFrame(r));
  const c = document.createElement("canvas");
  const w = video.videoWidth || 1280, h = video.videoHeight || 720;
  c.width=w; c.height=h;
  c.getContext("2d").drawImage(video,0,0,w,h);
  const blob = await new Promise(r=>c.toBlob(r,"image/jpeg",0.9));
  const fname = `${roomId}/${Date.now()}-${Math.random().toString(16).slice(2)}.jpg`;
  const { error } = await supabase.storage.from(BUCKET).upload(fname, blob, { contentType:"image/jpeg", upsert:false });
  if(error){ alert("上传失败："+error.message); return; }
  const { data:pub } = supabase.storage.from(BUCKET).getPublicUrl(fname);
  await supabase.from("messages").insert({ room_id:roomId, author:"我", content: pub.publicUrl });
  renderMessage("我", pub.publicUrl, true);
};
$("#closeCam").onclick = ()=>{
  if(mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; }
};

/** ====== 模板（简版示例） ====== **/
const templates = [
  "[状态] 我已到达",
  "[状态] 我已离开",
  "[系统] 我已拍照并上传",
  "[表单] 姓名=；数量=；备注="
];
$("#tplBtn").onclick = async ()=>{
  const label = "选择模板（或取消）：\n" + templates.map((t,i)=>`${i+1}. ${t}`).join("\n");
  const idx = prompt(label,"1");
  const n = Number(idx);
  if(Number.isFinite(n) && n>=1 && n<=templates.length){
    sendText(templates[n-1]);
  }
};

/** ====== 交互绑定 ====== **/
$("#join").onclick = joinRoom;
if(roomId) joinRoom();

$("#send").onclick = ()=> sendText($("#text").value.trim());
$("#text").addEventListener("keydown", e=>{ if(e.key==="Enter") $("#send").click(); });

/** 图片模式切换 **/
$("#modeSeg").addEventListener("click", e=>{
  const btn = e.target.closest("button"); if(!btn) return;
  [...$("#modeSeg").children].forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  imageMode = btn.dataset.mode;
  // 重新应用放大样式
  document.querySelectorAll("#log .msg").forEach(el=>{
    el.classList.remove("enlarge");
    const isMine = el.classList.contains("mine");
    const hasImg = !!el.querySelector("img");
    if(!hasImg) return;
    const shouldLarge =
      (imageMode==="all-large") ||
      (imageMode==="only-other" && !isMine);
    if(shouldLarge) el.classList.add("enlarge");
  });
});

/** 全屏图片预览 **/
const viewer = $("#viewer"), viewerImg = $("#viewer img");
logEl.addEventListener("click", e=>{
  const a = e.target.closest(".msg a.img-link"); if(!a) return;
  e.preventDefault();
  viewerImg.src = a.href; viewer.classList.add("show");
});
viewer.addEventListener("click", ()=> viewer.classList.remove("show"));
</script>
</html>
