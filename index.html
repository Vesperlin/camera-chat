<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no" />
<title>1v1 · 相机上传 + 聊天（移动端优化）</title>
<style>
  :root{
    --bg:#f5f6f8;
    --card:#ffffff;
    --border:#e9edf2;
    --text:#0b1220;
    --text-2:#6b7280;
    --primary:#3b82f6;
    --primary-2:#1d4ed8;
    --mine:#eef6ff;
    --mine-b:#cfe3ff;
    --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    background:var(--bg);
    color:var(--text);
  }

  /* 顶栏 */
  header{
    position:sticky; top:0; z-index:10;
    background:var(--card);
    border-bottom:1px solid var(--border);
    padding:10px env(safe-area-inset-right) 10px env(safe-area-inset-left);
  }
  .row{display:flex; gap:10px; align-items:center}
  input,button,select{
    font-size:16px; /* 防止 iOS 聚焦自动放大 */
    padding:10px 12px;
    border:1px solid var(--border);
    border-radius:12px;
    background:#fff;
  }
  input{flex:1; min-width:0}
  button.primary{
    background:var(--primary); color:#fff; border-color:transparent;
  }
  button.primary:active{background:var(--primary-2)}
  label{color:var(--text-2); display:flex; align-items:center; gap:6px}

  /* 内容区 */
  #content{height:calc(100dvh - 56px - 82px); /* 顶栏+工具栏 */ padding:10px; overflow:auto;}
  #log{display:flex; flex-direction:column; gap:10px}
  .msg{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:12px;
    padding:10px 12px;
  }
  .msg.mine{background:var(--mine); border-color:var(--mine-b)}
  .msg .author{font-weight:600; margin-right:6px}
  .msg .time{color:var(--text-2); font-size:12px; margin-left:8px}

  /* 图片缩略图 - 克制 */
  .msg img.thumb{
    display:block;
    width:100%;
    max-height:220px;
    object-fit:cover;
    border-radius:10px;
    cursor:zoom-in;
  }

  /* 底部工具条 */
  #toolbar{
    position:sticky; bottom:0; z-index:10;
    background:var(--card);
    border-top:1px solid var(--border);
    padding:8px env(safe-area-inset-right) calc(8px + env(safe-area-inset-bottom)) env(safe-area-inset-left);
    display:flex; flex-direction:column; gap:8px;
  }
  #toolRow{display:flex; gap:8px}
  #sendRow{display:flex; gap:8px}
  #text{flex:1}

  /* 全屏图片查看器 */
  #viewer{
    position:fixed; inset:0;
    background:rgba(0,0,0,.92);
    display:none; z-index:9999; color:#fff;
    padding-top:env(safe-area-inset-top);
    padding-bottom:env(safe-area-inset-bottom);
  }
  #viewer.show{display:block}
  #viewerTop{
    position:absolute; left:0; right:0; top:0;
    display:flex; align-items:center; justify-content:space-between;
    padding:14px 18px;
    -webkit-user-select:none; user-select:none;
  }
  #viewerClose{
    font-size:22px; line-height:22px;
    color:#fff;background:rgba(255,255,255,.16);
    border:0;border-radius:10px;padding:8px 12px;
  }
  #viewerCount{opacity:.85;font-size:14px}
  #viewerStage{ position:absolute; inset:0; top:50px; overflow:hidden; touch-action:none; }
  #viewerImg{
    position:absolute; left:50%; top:50%;
    transform: translate(-50%,-50%) scale(1);
    transform-origin:center center;
    will-change:transform;
    max-width:none; max-height:none;
  }
  .viewer-nav{
    position:absolute; top:50%; transform:translateY(-50%);
    border:0; border-radius:12px; width:44px; height:44px;
    background:rgba(255,255,255,.18); color:#fff; font-size:22px;
  }
  #viewerPrev{ left:12px }
  #viewerNext{ right:12px }
</style>
</head>
<body>

<header>
  <div class="row" style="gap:8px">
    <input id="room" placeholder="房间ID（字母数字）">
    <button id="join" class="primary">加入/创建</button>
    <label><input type="checkbox" id="bluetoothMode"> 朗读对方</label>
  </div>
</header>

<main id="content">
  <div id="log"></div>
</main>

<!-- 底部工具条 -->
<div id="toolbar">
  <div id="toolRow">
    <button id="openCam">开启相机</button>
    <button id="shot" class="primary" style="flex:1">拍照上传</button>
    <button id="closeCam" style="background:#fee2e2;border-color:#fecaca;color:#b91c1c">关闭相机</button>
  </div>
  <div id="sendRow">
    <input id="text" placeholder="发消息…（回车发送）">
    <button id="send" class="primary">发送</button>
  </div>
  <!-- 隐藏的视频承载相机流（不占位） -->
  <video id="preview" autoplay playsinline muted style="width:1px;height:1px;opacity:0;position:absolute;left:-9999px"></video>
</div>

<!-- 全屏图片查看器 -->
<div id="viewer" aria-hidden="true">
  <div id="viewerTop">
    <button id="viewerClose">关闭</button>
    <span id="viewerCount"></span>
  </div>
  <div id="viewerStage"><img id="viewerImg" alt=""></div>
  <button id="viewerPrev" class="viewer-nav" aria-label="上一张">‹</button>
  <button id="viewerNext" class="viewer-nav" aria-label="下一张">›</button>
</div>

<script type="module">
/* ====== Supabase 基本配置 ====== */
const SUPABASE_URL = "https://rcytjdvqyqbvuyzfcinu.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJjeXRqZHZxeXFidnV5emZjaW51Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1NDc2MzUsImV4cCI6MjA3NTEyMzYzNX0.RyG8f5IL_Yt0UL_rsrP7UILncM9Ek4TMIYq1dr2Zb-U";
const BUCKET = "photos";

import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ====== 小工具 ====== */
const $ = s => document.querySelector(s);
const logWrap = $("#log");
const seenIds = new Set(); // 防重复渲染
const allImageUrls = [];   // 给查看器用

function fmtTime(s){ try{ return new Date(s).toLocaleTimeString(); }catch{ return "" } }

function speak(text){
  if(!$("#bluetoothMode").checked) return;
  try{ const u = new SpeechSynthesisUtterance(text); u.lang="zh-CN"; speechSynthesis.speak(u);}catch{}
}

function appendMsg({id,author,content,created_at}){
  if(seenIds.has(id)) return;
  seenIds.add(id);
  const mine = author==="我";
  const div = document.createElement("div");
  div.className = "msg" + (mine?" mine":"");
  const head = `<span class="author">${author}</span><span class="time">${fmtTime(created_at)}</span>`;
  if(/^https?:\/\/.+\.(jpg|jpeg|png|webp|gif)(\?.*)?$/i.test(content)){
    div.innerHTML = `${head}<br><img class="thumb" src="${content}" alt="">`;
    logWrap.appendChild(div);
    const img = div.querySelector("img");
    registerThumb(img, content);
  }else{
    div.innerHTML = `${head}<span class="text">：${content}</span>`;
    logWrap.appendChild(div);
  }
  $("#content").scrollTop = $("#content").scrollHeight;
  if(!mine) speak(content);
}

/* ====== 房间与实时 ====== */
let roomId = new URL(location.href).searchParams.get("room") || "";
if(roomId) $("#room").value = roomId;
let dbChannel=null;

async function loadHistory(){
  const { data, error } = await supabase
    .from("messages")
    .select("*")
    .eq("room_id", roomId)
    .order("created_at", { ascending:true })
    .limit(200);
  logWrap.innerHTML = "";
  seenIds.clear(); allImageUrls.length=0;
  if(!error && data){
    data.forEach(appendMsg);
  }
}

async function joinRoom(){
  roomId = $("#room").value.trim() || crypto.randomUUID().slice(0,8);
  const url = new URL(location.href); url.searchParams.set("room",roomId); history.replaceState(null,"",url);

  await loadHistory();

  if(dbChannel) await supabase.removeChannel(dbChannel);
  dbChannel = supabase
    .channel("db:"+roomId)
    .on("postgres_changes",
      { event:"INSERT", schema:"public", table:"messages", filter:`room_id=eq.${roomId}` },
      payload => appendMsg(payload.new)
    )
    .subscribe((status)=>{/* 可观察状态 */});
}
$("#join").onclick = joinRoom;
if(roomId) joinRoom();

/* ====== 发送文本（只插入，不本地立即渲染，避免与 Realtime 重复） ====== */
async function sendText(){
  const v = $("#text").value.trim();
  if(!v || !roomId) return;
  const { error } = await supabase.from("messages").insert({ room_id:roomId, author:"我", content:v });
  if(error){ alert("发送失败："+error.message); return; }
  $("#text").value="";
}
$("#send").onclick = sendText;
$("#text").addEventListener("keydown", e => { if(e.key==="Enter") sendText(); });

/* ====== 相机与拍照上传 ====== */
let mediaStream=null;
const video = $("#preview");

$("#openCam").onclick = async ()=>{
  if(mediaStream) return;
  try{
    mediaStream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" }, audio:false });
    video.srcObject = mediaStream;
  }catch(e){ alert("相机权限失败："+e.message); }
};
$("#closeCam").onclick = ()=>{
  if(!mediaStream) return;
  mediaStream.getTracks().forEach(t=>t.stop());
  mediaStream=null; video.srcObject=null;
};

$("#shot").onclick = async ()=>{
  if(!roomId) return alert("请先加入房间");
  if(!mediaStream) return alert("请先开启相机");

  const c = document.createElement("canvas");
  const w = video.videoWidth || 1280, h = video.videoHeight || 720;
  c.width=w; c.height=h;
  c.getContext("2d").drawImage(video,0,0,w,h);
  const blob = await new Promise(r=>c.toBlob(r,"image/jpeg",0.9));
  const fname = `${roomId}/${Date.now()}-${Math.random().toString(16).slice(2)}.jpg`;

  const { error:upErr } = await supabase.storage.from(BUCKET)
    .upload(fname, blob, { contentType:"image/jpeg", upsert:false });
  if(upErr){ alert("上传失败："+upErr.message); return; }

  const { data:pub } = supabase.storage.from(BUCKET).getPublicUrl(fname);
  // 只发消息，渲染交给 Realtime
  await supabase.from("messages").insert({ room_id:roomId, author:"我", content:pub.publicUrl });
};

/* ====== 全屏图片查看器（缩放/拖拽/左右切换） ====== */
const viewer = $("#viewer");
const viewerImg = $("#viewerImg");
const viewerCount = $("#viewerCount");
const btnPrev = $("#viewerPrev");
const btnNext = $("#viewerNext");
$("#viewerClose").onclick = ()=> viewer.classList.remove('show');

let current = 0;
let scale = 1, baseScale = 1;
let startMid = null, startDist = 0;
let tx = 0, ty = 0;
let startTx = 0, startTy = 0;
let touchStartX = 0;

function registerThumb(imgEl, url){
  let idx = allImageUrls.indexOf(url);
  if(idx===-1){ allImageUrls.push(url); idx = allImageUrls.length-1; }
  imgEl.dataset.index = idx;
  imgEl.addEventListener('click', ()=> openViewer(idx));
}
function openViewer(index){
  current = index;
  updateImage();
  resetTransform();
  viewer.classList.add('show');
}
function updateImage(){
  const total = allImageUrls.length;
  viewerImg.src = allImageUrls[current];
  viewerCount.textContent = `${current+1} / ${total}`;
  btnPrev.style.display = (current>0)?'block':'none';
  btnNext.style.display = (current<total-1)?'block':'none';
}
btnPrev.onclick = ()=>{ if(current>0){ current--; updateImage(); resetTransform(); } };
btnNext.onclick = ()=>{ if(current<allImageUrls.length-1){ current++; updateImage(); resetTransform(); } };

let lastTap = 0;
const stage = document.getElementById('viewerStage');

stage.addEventListener('click', ()=>{
  const now = Date.now();
  if(now-lastTap<300){
    scale = (scale>1)?1:2.2;
    tx = ty = 0;
    applyTransform();
  }
  lastTap = now;
});
stage.addEventListener('touchstart', (e)=>{
  if(e.touches.length===1){
    touchStartX = e.touches[0].clientX;
    startTx = tx; startTy = ty;
  }else if(e.touches.length===2){
    const p1=e.touches[0], p2=e.touches[1];
    startDist = dist(p1,p2);
    startMid = mid(p1,p2);
    baseScale = scale;
  }
},{passive:false});
stage.addEventListener('touchmove', (e)=>{
  if(e.touches.length===1 && scale>1){
    const p=e.touches[0];
    tx = startTx + (p.clientX - touchStartX);
    ty = startTy + (p.clientY - (startMid?.clientY ?? p.clientY));
    clampPan(); applyTransform(); e.preventDefault();
  }else if(e.touches.length===2){
    const p1=e.touches[0], p2=e.touches[1];
    const factor = dist(p1,p2)/Math.max(1,startDist);
    scale = Math.min(4, Math.max(1, baseScale*factor));
    applyTransform(); e.preventDefault();
  }
},{passive:false});
stage.addEventListener('touchend', (e)=>{
  if(e.touches.length===0 && !startMid && scale===1){
    const endX = (e.changedTouches[0]||{}).clientX ?? 0;
    const delta = endX - touchStartX;
    if(Math.abs(delta)>60){
      if(delta<0 && current<allImageUrls.length-1){ current++; updateImage(); }
      else if(delta>0 && current>0){ current--; updateImage(); }
    }
  }
  if(scale<1){ scale=1; tx=ty=0; applyTransform(); }
  if(scale>4){ scale=4; applyTransform(); }
  startMid=null;
});
function applyTransform(){
  viewerImg.style.transform = `translate(calc(-50% + ${tx}px), calc(-50% + ${ty}px)) scale(${scale})`;
}
function resetTransform(){ scale=1; tx=ty=0; applyTransform(); }
function clampPan(){
  const limit = 200*(scale-1);
  tx = Math.max(-limit, Math.min(limit, tx));
  ty = Math.max(-limit, Math.min(limit, ty));
}
function dist(a,b){ const dx=a.clientX-b.clientX, dy=a.clientY-b.clientY; return Math.hypot(dx,dy); }
function mid(a,b){ return {clientX:(a.clientX+b.clientX)/2, clientY:(a.clientY+b.clientY)/2}; }
</script>
</body>
</html>
