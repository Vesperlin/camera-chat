<!doctype html>
<html lang="zh-CN">
<meta charset="utf-8" />
<meta name="viewport"
  content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
<title>相机上传 · 聊天</title>
<style>
  :root{
    --bg:#0b1220;            /* 背景深色 */
    --card:#0f172a;          /* 卡片深色 */
    --muted:#8ea2c9;
    --brand:#5b7cfa;         /* 主色（蓝紫） */
    --brand-2:#8b5cf6;
    --line:#20304f;
    --mine:#1e293b;
    --safe:env(safe-area-inset-bottom);
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%}
  body{
    margin:0;
    background: radial-gradient(1200px 600px at 50% -100px, #17213a 0, transparent 60%) , var(--bg);
    color:#e5edff;
    font:16px/1.45 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;
  }

  /* 布局 */
  .wrap{height:100%;display:flex;flex-direction:column}
  header{
    position:sticky;top:0;z-index:10;
    backdrop-filter:saturate(140%) blur(8px);
    background:linear-gradient(180deg,rgba(14,23,42,.9),rgba(14,23,42,.6) 60%,transparent);
    border-bottom:1px solid var(--line);
  }
  .topbar{display:flex;gap:10px;align-items:center;padding:10px 12px}
  .topbar input,.topbar select,.topbar button,.composer input,.composer button{
    font-size:16px;border:1px solid #283956;background:#0d1426;color:#e6eeff;
    border-radius:12px;padding:10px 12px;outline:none;
  }
  .btn{background:linear-gradient(135deg,var(--brand),var(--brand-2));border:none;color:#fff;font-weight:600}
  .switch{display:flex;align-items:center;gap:8px;color:#c6d4ff}
  .mode-tip{color:#93a5c8;font-size:12px}

  /* 消息区 */
  #log{flex:1;overflow:auto;padding:12px;scroll-behavior:smooth}
  .msg{max-width:86%;padding:10px 12px;margin:10px 0; border:1px solid #1c2a45;border-radius:14px;
       background:linear-gradient(180deg,#0e1730,#0b1427); box-shadow:0 6px 18px rgba(0,0,0,.25)}
  .mine{margin-left:auto;background:linear-gradient(180deg,#15233c,#0e1b31)}
  .author{display:block;color:#93a4c7;font-size:12px;margin-bottom:6px}
  .bubble{white-space:pre-wrap;word-break:break-word}
  .thumb{display:block;width:100%;max-height:180px;object-fit:cover;border-radius:10px;border:1px solid #243455}
  .enlarge .thumb{max-height:340px}
  .no-enlarge .thumb{max-height:120px}

  /* 底部工具条（固定） */
  .dock{
    position:sticky;bottom:0;z-index:10;border-top:1px solid var(--line);
    background:linear-gradient(0deg,rgba(10,16,30,.95),rgba(10,16,30,.85));
    padding:10px 10px calc(10px + var(--safe));
    display:flex;flex-direction:column;gap:10px;
  }
  .toolrow{display:flex;gap:10px}
  .toolrow button{flex:1;padding:12px;border-radius:12px}
  .toolrow .danger{background:#2a1b21;border-color:#432237;color:#ffb4c4}
  .composer{display:flex;gap:10px;align-items:center}
  .composer input{flex:1;background:#0c1428;border-color:#223150}

  /* 全屏图片查看 */
  #viewer{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:999}
  #viewer img{max-width:100vw;max-height:100vh; border-radius:8px; touch-action:manipulation}
  #viewer.show{display:flex}

  /* 防止 iOS 键盘顶起后遮挡输入条 */
  @supports (height:100dvh){
    .wrap{height:100dvh}
  }

  /* 小屏优化 */
  @media (max-width:390px){
    .topbar input{width:38%}
  }
</style>

<div class="wrap">
  <header>
    <div class="topbar">
      <input id="room" placeholder="房间ID（字母数字）" inputmode="latin" autocomplete="off">
      <button id="join" class="btn">加入/创建</button>
      <label class="switch"><input type="checkbox" id="bluetoothMode"> 朗读对方</label>
    </div>
    <div class="topbar" style="padding-top:0;">
      <label style="display:flex;align-items:center;gap:10px;">
        图片模式：
        <select id="imgMode">
          <option value="others">只放大对方</option>
          <option value="all">全部放大</option>
          <option value="off">不放大</option>
        </select>
      </label>
      <span class="mode-tip">（可随时切换）</span>
    </div>
  </header>

  <main id="log" aria-live="polite"></main>

  <footer class="dock">
    <div class="toolrow">
      <button id="openCam">开启相机</button>
      <button id="shot" class="btn">拍照上传</button>
      <button id="closeCam" class="danger">关闭相机</button>
    </div>
    <div class="composer">
      <input id="text" placeholder="发消息…（回车发送）" enterkeyhint="send" />
      <button id="send" class="btn">发送</button>
    </div>
    <video id="preview" autoplay playsinline muted style="display:none;width:100%;border-radius:12px;border:1px solid #223150"></video>
  </footer>
</div>

<!-- 全屏图片查看 -->
<div id="viewer"><img id="viewerImg" alt="查看图片"></div>

<script type="module">
const SUPABASE_URL = "https://rcytjdvqyqbvuyzfcinu.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJjeXRqZHZxeXFidnV5emZjaW51Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1NDc2MzUsImV4cCI6MjA3NTEyMzYzNX0.RyG8f5IL_Yt0UL_rsrP7UILncM9Ek4TMIYq1dr2Zb-U";
const BUCKET = "photos";

import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const $ = s => document.querySelector(s);
const logEl = $("#log");

/* ====== 基础 ====== */
const renderSet = new Set(); // 已渲染消息id，避免重复
let roomId = new URL(location.href).searchParams.get("room") || "";
if(roomId) $("#room").value = roomId;

let mediaStream=null;
let dbChannel=null;
let imgMode = localStorage.getItem("imgMode") || "others";
$("#imgMode").value = imgMode;
$("#imgMode").onchange = (e)=>{ imgMode = e.target.value; localStorage.setItem("imgMode", imgMode); applyImgMode(); };

function applyImgMode(){
  logEl.classList.remove("enlarge","no-enlarge");
  if(imgMode==="all") logEl.classList.add("enlarge");
  else if(imgMode==="off") logEl.classList.add("no-enlarge");
  // others 模式由每条消息的 mine/对方 决定（见 renderMessage）
}
applyImgMode();

function speak(text){
  if(!$("#bluetoothMode").checked) return;
  try{ const u=new SpeechSynthesisUtterance(text); u.lang="zh-CN"; speechSynthesis.speak(u);}catch(e){}
}

function scrollToBottom(){
  requestAnimationFrame(()=>{ logEl.scrollTop = logEl.scrollHeight; });
}

/* ====== 渲染 ====== */
function renderMessage(row){
  if(renderSet.has(row.id)) return;
  renderSet.add(row.id);

  const mine = row.author === "我";
  const box = document.createElement("div");
  box.className = "msg" + (mine ? " mine" : "");

  // 图片 or 文本
  const isImg = /^https?:\/\/.+\.(jpg|jpeg|png|webp|gif)(\?.*)?$/i.test(row.content);
  const author = document.createElement("span");
  author.className="author";
  author.textContent = mine ? "我" : (row.author||"对方");
  box.appendChild(author);

  if(isImg){
    const img = document.createElement("img");
    img.className = "thumb";
    img.src = row.content;
    img.alt = "图片";
    img.loading = "lazy";
    img.decoding = "async";
    img.addEventListener("click", ()=> openViewer(row.content));
    // others 模式：仅对方消息加大
    if(imgMode==="others" && !mine) box.classList.add("enlarge");
    box.appendChild(img);
  }else{
    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.textContent = row.content;
    box.appendChild(bubble);
  }

  logEl.appendChild(box);
  scrollToBottom();
  if(!mine) speak(row.content);
}

function openViewer(src){
  $("#viewerImg").src = src;
  $("#viewer").classList.add("show");
}
$("#viewer").addEventListener("click", ()=> $("#viewer").classList.remove("show"));

/* ====== 进房 ====== */
async function joinRoom(){
  roomId = $("#room").value.trim() || crypto.randomUUID().slice(0,8);
  const url=new URL(location.href); url.searchParams.set("room",roomId); history.replaceState(null,"",url);

  // 历史
  renderSet.clear();
  logEl.innerHTML="";
  const { data, error } = await supabase
    .from("messages")
    .select("id,author,content,created_at")
    .eq("room_id", roomId)
    .order("created_at", { ascending:true })
    .limit(300);
  if(!error && data) data.forEach(renderMessage);

  // 订阅
  if(dbChannel) await supabase.removeChannel(dbChannel);
  dbChannel = supabase.channel("room:"+roomId)
    .on("postgres_changes", { event:"INSERT", schema:"public", table:"messages", filter:`room_id=eq.${roomId}` },
      payload => renderMessage(payload.new))
    .subscribe((status)=>{
      // 可在这里提示连接状态
    });
}
$("#join").onclick = joinRoom;
if(roomId) joinRoom();

/* ====== 发送文字 ====== */
async function sendText(){
  const v = $("#text").value.trim();
  if(!v) return;
  const { data, error } = await supabase
    .from("messages")
    .insert({ room_id:roomId, author:"我", content:v })
    .select("id,author,content,created_at")
    .single();
  if(error){ alert("发送失败："+error.message); return; }
  renderMessage(data);  // 乐观渲染（有 id，不怕重复）
  $("#text").value="";
}
$("#send").onclick = sendText;
$("#text").addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); sendText(); }});

/* ====== 相机 ====== */
$("#openCam").onclick = async ()=>{
  try{
    mediaStream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" }, audio:false });
    $("#preview").style.display="block";
    $("#preview").srcObject = mediaStream;
  }catch(e){ alert("相机权限失败："+e.message); }
};
$("#closeCam").onclick = ()=>{
  if(mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; }
  $("#preview").style.display="none";
};

$("#shot").onclick = async ()=>{
  if(!mediaStream) return alert("请先开启相机");
  const video = $("#preview");
  const c = document.createElement("canvas");
  const w = video.videoWidth || 1280, h = video.videoHeight || 720;
  c.width=w; c.height=h;
  c.getContext("2d").drawImage(video,0,0,w,h);
  const blob = await new Promise(r=>c.toBlob(r,"image/jpeg",0.9));
  const fname = `${roomId}/${Date.now()}-${Math.random().toString(16).slice(2)}.jpg`;
  const { error:upErr } = await supabase.storage.from(BUCKET).upload(fname, blob, { contentType:"image/jpeg", upsert:false });
  if(upErr){ alert("上传失败："+upErr.message); return; }
  const { data:pub } = supabase.storage.from(BUCKET).getPublicUrl(fname);
  const { data, error } = await supabase
    .from("messages").insert({ room_id:roomId, author:"我", content: pub.publicUrl })
    .select("id,author,content,created_at").single();
  if(!error) renderMessage(data);
};
</script>
</html>
