<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CameraChat · B 聊天/拍照端</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h2>B 端（房间 1010）</h2>

    <div class="row">
      <input id="text" type="text" placeholder="输入文本（回车发送）" style="flex:1">
      <button id="send" class="btn primary">发送</button>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="openCam" class="btn">打开摄像头</button>
      <button id="shotUpload" class="btn">拍照上传</button>
      <input id="pick" type="file" accept="image/*" capture="environment" class="btn ghost" style="padding:6px">
    </div>

    <div class="log" id="log"></div>
  </div>

  <div class="small-thumb" id="thumb"><img></div>
  <div class="toast" id="toast"></div>

  <div class="videoPane" id="videoPane">
    <video id="cam" autoplay playsinline muted></video>
    <div class="camTop">
      <button id="closeCam" class="btn ghost">关闭相机</button>
    </div>
    <div class="camBottom">
      <button id="flip" class="btn ghost">前/后置</button>
      <button id="rotate" class="btn ghost">旋转90°</button>
      <button id="shoot" class="btn">拍照上传</button>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    import { SUPABASE_URL, SUPABASE_ANON_KEY, BUCKET, FIXED_ROOM_ID, AUTHOR_B } from "./sb-config.js";
    const sp = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $ = s=>document.querySelector(s);
    const toast=(t)=>{ const el=$("#toast"); el.textContent=t; el.classList.add("show"); setTimeout(()=>el.classList.remove("show"),1800); };

    const roomId = FIXED_ROOM_ID;
    const myId = AUTHOR_B; // B

    // --- chat ---
    const text = $("#text"), send = $("#send"), log=$("#log");
    send.onclick = sendText;
    text.addEventListener("keydown", e=>{ if(e.key==="Enter") sendText(); });
    async function sendText(){
      const v = text.value.trim(); if(!v) return;
      const { error } = await sp.from("messages").insert({ room_id: roomId, author_id: myId, type:"text", content: v });
      if(error) toast("发送失败："+error.message); else text.value="";
    }

    // --- album upload ---
    const fileInput = $("#pick"); const thumb=$("#thumb img");
    fileInput.onchange = async e=>{
      const f = e.target.files[0]; if(!f) return;
      const name = `${Date.now()}_${f.name||"photo.jpg"}`, path = `${roomId}/${name}`;
      const up = await sp.storage.from(BUCKET).upload(path, f);
      if(up.error){ toast("上传失败："+up.error.message); return; }
      const url = sp.storage.from(BUCKET).getPublicUrl(path).data.publicUrl;
      thumb.src = url;
      await sp.from("messages").insert({ room_id: roomId, author_id: myId, type:"image", content: url });
      toast("图片已上传");
      fileInput.value="";
    };

    // --- camera ---
    let stream=null, usingBack=true, rotation=0;
    const pane=$("#videoPane"), cam=$("#cam");
    async function openCam(){
      try{
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: usingBack?"environment":"user" }, audio:false });
      }catch(e){ return toast("相机失败："+e.message); }
      cam.srcObject = stream; await cam.play(); pane.classList.add("show");
    }
    function closeCam(){ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } pane.classList.remove("show"); }
    async function shoot(){
      if(!stream) return toast("先打开相机");
      const c=document.createElement("canvas"); const w = cam.videoWidth||1280, h=cam.videoHeight||720;
      if(rotation%180===0){ c.width=w; c.height=h; } else { c.width=h; c.height=w; }
      const ctx=c.getContext("2d");
      ctx.save();
      if(rotation%360===90){ ctx.translate(c.width,0); ctx.rotate(Math.PI/2); }
      else if(rotation%360===180){ ctx.translate(c.width,c.height); ctx.rotate(Math.PI); }
      else if(rotation%360===270){ ctx.translate(0,c.height); ctx.rotate(3*Math.PI/2); }
      ctx.drawImage(cam, 0,0,w,h); ctx.restore();

      const blob = await new Promise(r=>c.toBlob(r,"image/jpeg",0.92));
      const name=`shot_${Date.now()}.jpg`, path=`${roomId}/${name}`;
      const up = await sp.storage.from(BUCKET).upload(path, blob);
      if(up.error){ toast("上传失败："+up.error.message); return; }
      const url = sp.storage.from(BUCKET).getPublicUrl(path).data.publicUrl;
      thumb.src = url;
      await sp.from("messages").insert({ room_id: roomId, author_id: myId, type:"image", content:url });
      toast("拍照已上传");
    }
    $("#openCam").onclick = openCam;
    $("#closeCam").onclick = closeCam;
    $("#shoot").onclick = shoot;
    $("#shotUpload").onclick = shoot; // 顶部按钮也触发（如果相机已开）
    $("#flip").onclick = ()=>{ usingBack=!usingBack; closeCam(); openCam(); };
    $("#rotate").onclick = ()=>{ rotation=(rotation+90)%360; cam.style.transform=`rotate(${rotation}deg)`; };

    // --- render + realtime ---
    function render(list){
      log.innerHTML="";
      list.forEach(m=>{
        const row=document.createElement("div");
        row.className="msgRow "+(m.author_id===myId?"self":"");
        const bubble=document.createElement("div"); bubble.className="bubble";
        if(m.type==="image"){
          const a=document.createElement("a"); a.href=m.content; a.textContent="图片"; a.target="_blank";
          bubble.appendChild(a);
        }else{
          const p=document.createElement("p"); p.textContent=m.content; bubble.appendChild(p);
        }
        row.appendChild(bubble); log.appendChild(row);
      });
      log.scrollTop = log.scrollHeight;
    }
    async function load(){
      const { data, error } = await sp.from("messages")
        .select("*").eq("room_id", roomId).order("created_at",{ascending:true}).limit(500);
      if(error){ toast("加载失败："+error.message); return; }
      render(data||[]);
    }
    sp.channel("room-"+roomId)
      .on("postgres_changes",
          { event:"*", schema:"public", table:"messages", filter:`room_id=eq.${roomId}`},
          () => load())
      .subscribe();

    load();
  </script>
</body>
</html>
