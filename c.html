<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CameraChat · C 监听端</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h2>C 监听端（房间 1010）</h2>

    <div class="row">
      <input id="text" type="text" placeholder="此端仅监听，禁止发言" disabled style="flex:1">
      <button id="send" class="btn" disabled>发送</button>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn" disabled>打开摄像头</button>
      <button class="btn" disabled>拍照上传</button>
      <button class="btn ghost" disabled>从相册选择</button>
    </div>

    <div class="log" id="log"></div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    import { SUPABASE_URL, SUPABASE_ANON_KEY, FIXED_ROOM_ID, AUTHOR_C } from "./sb-config.js";
    const sp = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const roomId = FIXED_ROOM_ID;
    const myId = AUTHOR_C;

    const $=s=>document.querySelector(s);
    const toast=(t)=>{ const el=$("#toast"); el.textContent=t; el.classList.add("show"); setTimeout(()=>el.classList.remove("show"),1800); };
    const log=$("#log");

    function render(list){
      log.innerHTML="";
      list.forEach(m=>{
        const row=document.createElement("div");
        row.className="msgRow "+(m.author_id===myId?"self":"");
        const b=document.createElement("div"); b.className="bubble";
        if(m.type==="image"){
          const a=document.createElement("a"); a.href=m.content; a.textContent="图片"; a.target="_blank";
          b.appendChild(a);
        }else{
          const p=document.createElement("p"); p.textContent=m.content; b.appendChild(p);
        }
        row.appendChild(b); log.appendChild(row);
      });
      log.scrollTop = log.scrollHeight;
    }

    async function load(){
      const { data, error } = await sp.from("messages")
        .select("*").eq("room_id", roomId).order("created_at",{ascending:true}).limit(500);
      if(error){ toast("加载失败："+error.message); return; }
      render(data||[]);
    }

    sp.channel("room-"+roomId)
      .on("postgres_changes",
        { event:"*", schema:"public", table:"messages", filter:`room_id=eq.${roomId}`},
        ()=> load())
      .subscribe();

    load();
  </script>
</body>
</html>
