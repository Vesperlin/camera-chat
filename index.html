<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>1v1 · 相机上传 + 聊天（移动优化）</title>
<style>
  :root{
    --bg:#f6f7fb;
    --card:#fff;
    --primary:#4c6fff;
    --primary-weak:#e8ecff;
    --text:#111;
    --sub:#666;
    --border:#e9e9ef;
    --safe-bottom: env(safe-area-inset-bottom, 0px);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    -webkit-tap-highlight-color: transparent;
    font:16px/1.5 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    display:flex;flex-direction:column;
  }

  /* 顶部条 */
  .topbar{
    position:sticky;top:0;z-index:20;
    background:var(--card);
    border-bottom:1px solid var(--border);
    padding:10px 12px;
    display:flex;gap:8px;align-items:center;flex-wrap:wrap;
  }
  .topbar .row{display:flex;gap:8px;align-items:center;flex:1;min-width:240px}
  input,button,select{
    font-size:16px; /* 关键：防止 iOS Safari 自动放大 */
    border:1px solid var(--border);
    background:#fff;border-radius:12px;padding:10px 12px;
  }
  input{flex:1;min-width:0}
  button.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
  label{color:var(--sub);display:flex;gap:6px;align-items:center}

  /* 图片模式切换 */
  .modebar{
    padding:8px 12px;color:#4b6;display:flex;gap:8px;align-items:center;flex-wrap:wrap
  }
  .modebar small{color:#999}

  /* 内容区（消息列表） */
  #log{
    flex:1;overflow:auto;
    padding:12px;display:flex;flex-direction:column;gap:10px;
  }
  .msg{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:14px;padding:10px 12px;
    max-width: 88%;
    box-shadow:0 1px 0 rgba(0,0,0,.02);
  }
  .mine{align-self:flex-end;background:var(--primary-weak);border-color:#dae2ff}
  .meta{font-size:12px;color:#999;margin-bottom:4px}
  .msg img{display:block;border-radius:10px;width:100%;height:auto}

  /* 图片大小策略 */
  /* 基础：消息内图片在手机上默认适中（宽度 68% 容器宽） */
  .msg .pic{width:68vw;max-width:460px}
  /* 放大全部 */
  .enlarge-all .msg .pic{width:88vw;max-width:620px}
  /* 仅放大“对方” */
  .enlarge-others .msg:not(.mine) .pic{width:88vw;max-width:620px}
  /* 关闭放大（都较小） */
  .enlarge-off .msg .pic{width:52vw;max-width:360px}

  /* 底部工具栏（始终可用，避让 Home 条） */
  .toolbar{
    position:sticky;bottom:0;z-index:30;
    padding:10px 12px calc(10px + var(--safe-bottom));
    background:rgba(255,255,255,.86);
    backdrop-filter:saturate(160%) blur(12px);
    border-top:1px solid var(--border);
    display:flex;gap:8px;align-items:center;flex-wrap:wrap;
  }
  .tool-top{display:flex;gap:8px;width:100%}
  .tool-bottom{display:flex;gap:8px;width:100%}

  .tool-top input[type=text]{flex:1}
  .btn-ghost{background:#fff}

  /* 小预览条（相机开启时） */
  #camBar{
    width:100%;display:none;align-items:center;gap:8px;
    background:#fff;border:1px dashed var(--border);border-radius:10px;padding:8px;
  }
  #preview{display:block;width:120px;height:68px;border-radius:8px;object-fit:cover;background:#000}

  /* 小屏优化：按钮尺寸更易点 */
  @media (max-width:390px){
    button,select{padding:10px}
  }
</style>
</head>
<body class="enlarge-others"><!-- 默认：只放大对方 -->

  <div class="topbar">
    <div class="row" style="flex:1">
      <input id="room" placeholder="房间ID（字母数字）">
      <button id="join" class="primary">加入/创建</button>
    </div>
    <label><input type="checkbox" id="bluetoothMode"> 朗读对方</label>
  </div>

  <div class="modebar">
    <label>图片模式：
      <select id="imgMode">
        <option value="enlarge-others" selected>只放大对方</option>
        <option value="enlarge-all">全部放大</option>
        <option value="enlarge-off">关闭放大</option>
      </select>
    </label>
    <small>（可随时切换）</small>
  </div>

  <div id="log"></div>

  <div class="toolbar">
    <!-- 相机状态条 -->
    <div id="camBar">
      <video id="preview" autoplay playsinline muted></video>
      <div style="flex:1;color:#666;font-size:13px">相机已开启，可随时拍照上传</div>
    </div>

    <!-- 顶行：相机控制 -->
    <div class="tool-top">
      <button id="openCam" class="btn-ghost">开启相机</button>
      <button id="shot" class="primary" style="flex:1">拍照上传</button>
      <button id="closeCam" class="btn-ghost" style="color:#d33;border-color:#ffd9d9;background:#fff5f5">关闭相机</button>
    </div>

    <!-- 底行：发送消息 -->
    <div class="tool-bottom">
      <input id="text" type="text" placeholder="发消息…（回车发送）" />
      <button id="send" class="primary">发送</button>
    </div>
  </div>

<script type="module">
const SUPABASE_URL = "https://rcytjdvqyqbvuyzfcinu.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJjeXRqZHZxeXFidnV5emZjaW51Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1NDc2MzUsImV4cCI6MjA3NTEyMzYzNX0.RyG8f5IL_Yt0UL_rsrP7UILncM9Ek4TMIYq1dr2Zb-U";
const BUCKET = "photos";

import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const $ = s => document.querySelector(s);

const logBox = $("#log");
function addMsg({author, content, mine=false}){
  const wrap = document.createElement("div");
  wrap.className = "msg" + (mine ? " mine" : "");
  const isImg = /^https?:\/\/.+\.(jpg|jpeg|png|webp|gif)(\?.*)?$/i.test(content);
  wrap.innerHTML = `
    <div class="meta">${mine ? "我" : author || "Ta"}</div>
    ${isImg ? `<img class="pic" src="${content}" alt="photo">` : `<div>${escapeHtml(content)}</div>`}
  `;
  logBox.appendChild(wrap);
  logBox.scrollTop = logBox.scrollHeight;
}
function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]))}

function speak(text){
  if(!$("#bluetoothMode").checked) return;
  try{ const u = new SpeechSynthesisUtterance(text); u.lang = "zh-CN"; speechSynthesis.speak(u);}catch(e){}
}

/* ------- 房间/订阅 ------- */
let roomId = new URL(location.href).searchParams.get("room") || "";
if(roomId) $("#room").value = roomId;

let dbChannel = null;
async function joinRoom(){
  roomId = $("#room").value.trim() || crypto.randomUUID().slice(0,8);
  const url = new URL(location.href); url.searchParams.set("room",roomId); history.replaceState(null,"",url);

  // 历史消息
  await loadHistory();

  // 订阅实时
  if(dbChannel) await supabase.removeChannel(dbChannel);
  dbChannel = supabase
    .channel("db:"+roomId)
    .on("postgres_changes",
      {event:"INSERT", schema:"public", table:"messages", filter:`room_id=eq.${roomId}`},
      payload=>{
        const m = payload.new;
        addMsg({author:m.author, content:m.content, mine:m.author==="我"});
        if(m.author!=="我") speak(m.content);
      }
    ).subscribe();
}
$("#join").onclick = joinRoom;
if(roomId) joinRoom();

/* ------- 历史 ------- */
async function loadHistory(){
  const { data, error } = await supabase.from("messages")
    .select("author,content,created_at")
    .eq("room_id", roomId)
    .order("created_at", {ascending:true})
    .limit(200);
  if(error) return;
  logBox.innerHTML="";
  for(const m of data){
    addMsg({author:m.author, content:m.content, mine:m.author==="我"});
  }
}

/* ------- 发送文字（不本地重复渲染，等 Realtime） ------- */
async function sendText(v){
  if(!v) return;
  const { error } = await supabase.from("messages").insert({room_id:roomId, author:"我", content:v});
  if(error){ alert("发送失败："+error.message); return; }
  $("#text").value=""; // 等订阅回显，避免双渲染
}
$("#send").onclick = ()=> sendText($("#text").value.trim());
$("#text").addEventListener("keydown", e=>{ if(e.key==="Enter") $("#send").click(); });

/* ------- 图片模式切换 ------- */
$("#imgMode").addEventListener("change", e=>{
  document.body.classList.remove("enlarge-others","enlarge-all","enlarge-off");
  document.body.classList.add(e.target.value);
});

/* ------- 相机 ------- */
let mediaStream=null;
const preview = $("#preview");
const camBar = $("#camBar");

$("#openCam").onclick = async ()=>{
  try{
    mediaStream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" }, audio:false });
    preview.srcObject = mediaStream;
    camBar.style.display = "flex";
  }catch(e){ alert("相机权限失败："+e.message); }
};
$("#closeCam").onclick = ()=>{
  if(mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; }
  preview.srcObject = null;
  camBar.style.display = "none";
};

$("#shot").onclick = async ()=>{
  if(!roomId) return alert("请先加入/创建房间");
  if(!mediaStream) return alert("请先开启相机");

  const video = preview;
  const c = document.createElement("canvas");
  const w = video.videoWidth || 1280, h = video.videoHeight || 720;
  c.width=w; c.height=h;
  c.getContext("2d").drawImage(video,0,0,w,h);
  const blob = await new Promise(r=>c.toBlob(r,"image/jpeg",0.9));
  const fname = `${roomId}/${Date.now()}-${Math.random().toString(16).slice(2)}.jpg`;

  const { error } = await supabase.storage.from(BUCKET).upload(fname, blob, { contentType:"image/jpeg", upsert:false });
  if(error){ alert("上传失败："+error.message); return; }
  const { data:pub } = supabase.storage.from(BUCKET).getPublicUrl(fname);

  // 只写库，等 Realtime 渲染
  const { error:insErr } = await supabase.from("messages").insert({ room_id:roomId, author:"我", content:pub.publicUrl });
  if(insErr){ alert("写入消息失败："+insErr.message); }
};

/* 初始模式同步（防止历史选择残留） */
document.body.classList.add($("#imgMode").value);
</script>
</body>
</html>
