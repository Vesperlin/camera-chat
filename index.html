<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>1v1 · 相机上传 + 聊天（移动端优化）</title>
<style>
:root{
  --c-0:#06141B; --c-1:#11212D; --c-2:#253745; --c-3:#4A5C6A; --c-4:#9BA8AB; --c-5:#CCD0CF;
  --bg:var(--c-0); --panel: #0b1a23; --card:#0f2230; --muted:#7f8d95; --brand:#6fa2ff; --danger:#9c2b2b;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,var(--bg) 0%, #0b1b25 100%);color:#e9eef1;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
a{color:inherit}
button,input,select{font-size:16px;border-radius:12px;border:1px solid #223341;background:#0e2230;color:#e9eef1;outline:none}
button{padding:10px 14px}
input{padding:10px 12px}

/* 顶部条 */
.header{position:sticky;top:env(safe-area-inset-top);z-index:5;background:rgba(6,20,27,.7);backdrop-filter:saturate(120%) blur(8px); padding:10px 12px}
.row{display:flex;gap:10px;align-items:center}
.header .row{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:10px}

/* 日志区 */
#log{padding:12px; padding-bottom:180px; max-width:900px; margin:0 auto}
.msg{display:flex;gap:8px;margin:12px 0}
.msg.me{justify-content:flex-end}
.bubble{
  background:var(--card); border:1px solid rgba(255,255,255,.07); border-radius:16px; padding:10px 12px;
  max-width:70vw; position:relative;
}
.meta{font-size:12px;color:var(--muted);margin-bottom:6px;display:flex;gap:8px}
.author{color:#bcd6e4}
.me .bubble{background:linear-gradient(180deg,#132b3b,#102632)}
.me .author{display:none}

/* 图像尺寸：默认缩略（小）*/
.bubble img{display:block;width:100%;height:auto;border-radius:10px}
.thumb{max-width:52vw}
@media (orientation:landscape){ .thumb{max-width:40vw} }
.big{max-width:70vw}

/* 图片模式切换：通过 body 上的类控制 */
body.mode-peer .msg.me img.thumb{max-width:38vw}          /* 只放大对方：我方更小 */
body.mode-allbig .bubble img{max-width:70vw}               /* 全部放大 */
body.mode-allsmall .bubble img{max-width:38vw}             /* 全部缩略 */

/* 工具条（细） */
.tools{
  position:fixed;left:0;right:0;bottom:92px;z-index:6;display:flex;gap:10px;justify-content:center;
  padding:8px; 
}
.tools .bar{display:flex;gap:8px; padding:8px; border-radius:16px; background:rgba(15,34,48,.9); border:1px solid rgba(255,255,255,.08)}
.tools select{background:#0b2030}

/* 输入条（固定底部） */
.inputDock{
  position:fixed;left:0;right:0;bottom:0;z-index:6; padding:10px 10px calc(10px + env(safe-area-inset-bottom));
  background:linear-gradient(180deg,rgba(6,20,27,.3),rgba(6,20,27,.9));
  backdrop-filter: blur(8px);
  border-top:1px solid rgba(255,255,255,.06);
}
.inputDock .wrap{display:flex;gap:10px;align-items:center;max-width:900px;margin:0 auto}
#text{flex:1;background:#0e2230;border:1px solid rgba(255,255,255,.08)}
#send{background:#2e5cff;border-color:#2e5cff}
.badge{font-size:12px;color:var(--muted)}

/* 按钮色系 */
.btn{background:#153247;border:1px solid #254459}
.btn.primary{background:#3c63ff;border-color:#3c63ff}
.btn.danger{background:#3a1212;border-color:#6a1e1e}

/* 全屏预览 */
#lightbox{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;z-index:999}
#lightbox img{max-width:96vw;max-height:92vh;border-radius:12px}
#lightbox:active{display:none}
.closeHint{position:fixed;bottom:12px;left:0;right:0;text-align:center;color:#9BA8AB;font-size:12px}

/* 小提示 */
.sys{color:#9BA8AB;font-size:12px;margin:10px auto;max-width:82vw;text-align:center}
.hidden{display:none}
</style>
</head>
<body class="mode-peer">

<!-- 顶部 -->
<div class="header">
  <div class="row">
    <input id="room" placeholder="房间ID（字母数字）" autocomplete="off">
    <button id="join" class="btn primary">加入/创建</button>
    <label class="badge"><input id="bluetoothMode" type="checkbox"> 朗读对方</label>
  </div>
  <div class="row" style="margin-top:8px">
    <span class="badge">图片模式：</span>
    <button class="btn" data-mode="mode-peer">只放大对方</button>
    <button class="btn" data-mode="mode-allsmall">全部缩略</button>
    <button class="btn" data-mode="mode-allbig">全部放大</button>
    <span class="badge">(可随时切换)</span>
  </div>
</div>

<!-- 日志 -->
<div id="log"></div>

<!-- 工具条（细） -->
<div class="tools">
  <div class="bar">
    <button id="openCam" class="btn">开启相机</button>
    <button id="shot" class="btn primary">拍照上传</button>
    <button id="closeCam" class="btn danger">关闭相机</button>
    <button id="tplBtn" class="btn">模板</button>
  </div>
</div>

<!-- 输入 dock -->
<div class="inputDock">
  <div class="wrap">
    <input id="text" placeholder="发消息…（回车发送）">
    <button id="send">发送</button>
  </div>
</div>

<!-- 预览 video（隐藏占位） -->
<video id="preview" autoplay playsinline muted class="hidden"></video>

<!-- 模板弹层 -->
<dialog id="tplDlg" style="background:#0b1b26;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px;max-width:92vw">
  <h3 style="margin:0 0 8px 0;color:#e6eef2">快速模板</h3>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
    <button class="btn tpl">[状态] 我已到达</button>
    <button class="btn tpl">[状态] 我已离开</button>
    <button class="btn tpl">[系统] 我已拍照并上传</button>
    <button class="btn tpl">[表单] 姓名=；数量=；备注=</button>
  </div>
  <div class="row" style="margin-top:10px;justify-content:flex-end">
    <button onclick="tplDlg.close()" class="btn">关闭</button>
  </div>
</dialog>

<!-- 全屏图片预览 -->
<div id="lightbox"><img><div class="closeHint">轻触任意处关闭</div></div>

<script type="module">
/*** === 基础配置 === ***/
const SUPABASE_URL = "https://rcytjdvqyqbvuyzfcinu.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJjeXRqZHZxeXFidnV5emZjaW51Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1NDc2MzUsImV4cCI6MjA3NTEyMzYzNX0.RyG8f5IL_Yt0UL_rsrP7UILncM9Ek4TMIYq1dr2Zb-U";
const BUCKET = "photos";

import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/*** === DOM/工具 === ***/
const $ = s=>document.querySelector(s);
const logWrap = $("#log");
function sys(t){ const d=document.createElement("div"); d.className="sys"; d.textContent=t; logWrap.appendChild(d); }
function scrollBottom(){ requestAnimationFrame(()=>{ window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"}); }) }

function renderMessage(m){
  const me = m.author==="我";
  const row = document.createElement("div"); row.className = "msg " + (me?"me":"peer");
  const bubble = document.createElement("div"); bubble.className="bubble";
  const meta = document.createElement("div"); meta.className="meta";
  const ts = new Date(m.created_at||Date.now()).toLocaleTimeString('zh-CN',{hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'});
  meta.innerHTML = `<span class="author">${me?"我":"对方"}</span><span>${ts}</span>`;
  bubble.appendChild(meta);

  const isImg = /^https?:\/\/.+\.(jpg|jpeg|png|webp|gif)(\?.*)?$/i.test(m.content);
  if(isImg){
    const img=document.createElement("img");
    img.src=m.content;
    img.className = (document.body.classList.contains("mode-allbig"))?"big":"thumb";
    img.loading="lazy";
    img.onclick=()=>{ $("#lightbox img").src = img.src; $("#lightbox").style.display="flex"; };
    bubble.appendChild(img);
  }else{
    const p=document.createElement("div");
    p.textContent=m.content;
    bubble.appendChild(p);
  }
  row.appendChild(bubble);
  logWrap.appendChild(row);
}

/*** === 朗读 === ***/
function speak(text){
  if(!$("#bluetoothMode").checked) return;
  try{ const u = new SpeechSynthesisUtterance(text); u.lang="zh-CN"; speechSynthesis.speak(u);}catch(e){}
}

/*** === 状态 === ***/
let roomId = new URL(location.href).searchParams.get("room") || "";
if(roomId) $("#room").value = roomId;
let mediaStream=null, dbChannel=null;

/*** === 进入房间 === ***/
async function joinRoom(){
  roomId = $("#room").value.trim() || crypto.randomUUID().slice(0,8);
  const url=new URL(location.href); url.searchParams.set("room",roomId); history.replaceState(null,"",url);
  sys(`房间：${roomId}（把此链接发给对方即可同房间）`);

  // 历史
  const { data } = await supabase.from("messages").select("author,content,created_at").eq("room_id",roomId).order("created_at",{ascending:true}).limit(200);
  logWrap.innerHTML=""; (data||[]).forEach(renderMessage); scrollBottom();

  // 订阅
  if(dbChannel) await supabase.removeChannel(dbChannel);
  dbChannel = supabase.channel("db:"+roomId)
    .on("postgres_changes",
      {event:"INSERT",schema:"public",table:"messages",filter:`room_id=eq.${roomId}`},
      ({new: m})=>{
        renderMessage(m);
        if(m.author!=="我") speak(m.content);
        scrollBottom();
      }
    ).subscribe();
}
$("#join").onclick = joinRoom;
if(roomId) joinRoom();

/*** === 发送文字 === ***/
async function sendText(v){
  v = (v||"").trim(); if(!v) return;
  const { error } = await supabase.from("messages").insert({ room_id:roomId, author:"我", content:v });
  if(error) { alert("发送失败："+error.message); return; }
  // 乐观渲染一份（防止网络慢）
  renderMessage({author:"我",content:v,created_at:new Date().toISOString()});
  $("#text").value=""; scrollBottom();
}
$("#send").onclick = ()=> sendText($("#text").value);
$("#text").addEventListener("keydown", e=>{ if(e.key==="Enter") sendText($("#text").value); });

/*** === 相机 === ***/
$("#openCam").onclick = async ()=>{
  try{
    mediaStream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" }, audio:false });
    $("#preview").srcObject = mediaStream; $("#preview").classList.remove("hidden");
    sys("相机已开启");
  }catch(e){ alert("相机权限失败："+e.message); }
};
$("#closeCam").onclick = ()=>{ if(mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; $("#preview").classList.add("hidden"); sys("相机已关闭"); } };

$("#shot").onclick = async ()=>{
  if(!mediaStream) return alert("请先开启相机");
  const video = $("#preview");
  const w = video.videoWidth || 1280, h = video.videoHeight || 720;
  const c = document.createElement("canvas"); c.width=w; c.height=h; c.getContext("2d").drawImage(video,0,0,w,h);
  const blob = await new Promise(r=>c.toBlob(r,"image/jpeg",0.9));
  const fname = `${roomId}/${Date.now()}-${Math.random().toString(16).slice(2)}.jpg`;
  const { error } = await supabase.storage.from(BUCKET).upload(fname, blob, { contentType:"image/jpeg", upsert:false });
  if(error){ alert("上传失败："+error.message); return; }
  const { data:pub } = supabase.storage.from(BUCKET).getPublicUrl(fname);
  await supabase.from("messages").insert({ room_id:roomId, author:"我", content: pub.publicUrl });
  // 本地也先展示一个缩略
  renderMessage({author:"我",content:pub.publicUrl,created_at:new Date().toISOString()});
  scrollBottom();
};

/*** === 图片模式切换 === ***/
document.querySelectorAll('[data-mode]').forEach(btn=>{
  btn.onclick=()=>{
    document.body.classList.remove("mode-peer","mode-allsmall","mode-allbig");
    document.body.classList.add(btn.dataset.mode);
  };
});

/*** === 模板 === ***/
$("#tplBtn").onclick = ()=> $("#tplDlg").showModal();
$("#tplDlg").addEventListener("click",(e)=>{
  if(e.target.classList.contains("tpl")){ sendText(e.target.textContent); $("#tplDlg").close(); }
});

/*** === 全屏预览关闭 === ***/
$("#lightbox").addEventListener("click",()=> $("#lightbox").style.display="none");
</script>
</body>
</html>
